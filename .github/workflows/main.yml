name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Repository auschecken
      uses: actions/checkout@v3

    - name: Python einrichten
      uses: actions/setup-python@v4
      with:
        python-version: '3.9.13'

    - name: System-Abhängigkeiten installieren
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip python3-pip \
          autoconf libtool pkg-config zlib1g-dev \
          libncurses5-dev libncursesw5-dev libtinfo-dev \
          cmake libffi-dev libssl-dev patch wget

    - name: JDK für Android und Ant einrichten
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Apache Ant manuell vorbereiten
      run: |
        mkdir -p /home/runner/.buildozer/android/platform
        cd /home/runner/.buildozer/android/platform
        wget -q https://dlcdn.apache.org/ant/binaries/apache-ant-1.10.12-bin.tar.gz
        tar -xf apache-ant-1.10.12-bin.tar.gz
        rm apache-ant-1.10.12-bin.tar.gz

    - name: Python-Abhängigkeiten installieren
      run: |
        python -m pip install --upgrade pip
        pip install cython==0.29.24
        pip install buildozer==1.5.0 pyjnius

    - name: buildozer.spec anpassen
      run: |
        sed -i 's/^# *android.sdk = 24/android.sdk = 27/' buildozer.spec
        sed -i 's/^# *android.ndk = 25b/android.ndk = 25b/' buildozer.spec
        sed -i '/^android.sdk_path =/d' buildozer.spec
        sed -i '/^android.ndk_path =/d' buildozer.spec
        sed -i '/^android.buildtool =/d' buildozer.spec
        sed -i '/^android.accept_sdk_license =/d' buildozer.spec
        echo "android.buildtool = 36.0.0" >> buildozer.spec
        echo "android.accept_sdk_license = 1" >> buildozer.spec
        grep -q "android.add_aab_cmdline_tools = 1" buildozer.spec || echo "android.add_aab_cmdline_tools = 1" >> buildozer.spec

    - name: Lizenzen manuell akzeptieren
      run: |
        mkdir -p /home/runner/.buildozer/android/platform/android-sdk/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > /home/runner/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" >> /home/runner/.buildozer/android/platform/android-sdk/licenses/android-sdk-license

    - name: Build-Tools 36 manuell installieren (failsafe für aidl)
      run: |
        echo "Installiere Build-Tools 36.0.0 über sdkmanager..."
        yes | /home/runner/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin/sdkmanager "build-tools;36.0.0" || echo "Build-Tools eventuell bereits installiert"

    - name: Umgebung prüfen
      run: |
        echo "Buildozer:"
        buildozer --version
        echo "Java:"
        java
