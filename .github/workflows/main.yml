# Name des Workflows
name: Build Android APK with BeeWare Briefcase

# Trigger für den Workflow
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    # Der Job läuft auf der neuesten Ubuntu-Version
    runs-on: ubuntu-latest

    steps:
    # 1. Repository auschecken
    - name: Repository auschecken
      uses: actions/checkout@v4

    # 2. Python-Umgebung einrichten
    - name: Python einrichten
      uses: actions/setup-python@v5
      with:
        python-version: '3.9' # Oder Ihre bevorzugte Python-Version

    # 3. Java Development Kit (JDK) einrichten (für Android SDK, von Briefcase benötigt)
    - name: Java JDK einrichten (für Android SDK)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 4. Briefcase installieren
    - name: Briefcase installieren
      run: |
        python -m pip install --upgrade pip
        pip install briefcase

    # 5. Bereite App-Struktur vor und erstelle die Android APK
    - name: Bereite App-Struktur vor und erstelle die Android APK
      run: |
        # Briefcase erwartet, dass Ihre App ein Python-Paket ist.
        # Wenn Ihr Projekt nicht bereits so strukturiert ist,
        # erstellen wir hier ein Beispielpaket 'mypythonapp'.
        #
        # WICHTIG: Im echten Projekt sollten Sie diese Verzeichnisstruktur
        # (z.B. 'mypythonapp/__init__.py', 'mypythonapp/main.py')
        # und die 'pyproject.toml' **direkt in Ihrem Git-Repository** haben!
        
        APP_PACKAGE_DIR="mypythonapp" # Muss dem App-Namen in pyproject.toml entsprechen
        
        # Erstelle das Paketverzeichnis, falls es nicht existiert
        echo "Erstelle Paketverzeichnis: $APP_PACKAGE_DIR"
        mkdir -p "$APP_PACKAGE_DIR"
        
        # Erstelle eine leere __init__.py, falls nicht vorhanden (macht es zu einem Python-Paket)
        echo "Erstelle __init__.py in $APP_PACKAGE_DIR/__init__.py"
        if [ ! -f "$APP_PACKAGE_DIR/__init__.py" ]; then
            touch "$APP_PACKAGE_DIR/__init__.py"
        fi
        
        # Verschiebe oder erstelle main.py im Paketverzeichnis, falls notwendig
        # (passen Sie dies an, wenn Ihre main.py woanders ist oder anders heißt)
        echo "Erstelle main.py in $APP_PACKAGE_DIR/main.py"
        if [ ! -f "$APP_PACKAGE_DIR/main.py" ]; then
            echo "print('Hallo von meiner BeeWare Android App!')" > "$APP_PACKAGE_DIR/main.py"
        fi

        # Optional: Erstelle eine leere LICENSE-Datei, wenn nicht vorhanden,
        # um die Lizenzwarnung zu vermeiden.
        echo "Erstelle/prüfe LICENSE-Datei..."
        if [ ! -f LICENSE ]; then
            echo "Copyright (c) $(date +%Y) Ihr Name" > LICENSE
            echo "" >> LICENSE
            echo "MIT License" >> LICENSE
            echo "" >> LICENSE
            echo "Permission is hereby granted, free of charge, to any person obtaining a copy" >> LICENSE
            echo "of this software and associated documentation files (the \"Software\"), to deal" >> LICENSE
            echo "in the Software without restriction, including without limitation the rights" >> LICENSE
            echo "to use, copy, modify, merge, publish, distribute, sublicense, and/or sell" >> LICENSE
            echo "copies of the Software, and to permit persons to whom the Software is" >> LICENSE
            echo "furnished to do so, subject to the following conditions:" >> LICENSE
            echo "" >> LICENSE
            echo "The above copyright notice and this permission notice shall be included in all" >> LICENSE
            echo "copies or substantial portions of the Software." >> LICENSE
            echo "" >> LICENSE
            echo "THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR" >> LICENSE
            echo "IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY," >> LICENSE
            echo "FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE" >> LICENSE
            echo "AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER" >> LICENSE
            echo "LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM," >> LICENSE
            echo "OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE" >> LICENSE
            echo "SOFTWARE." >> LICENSE
        fi


        # Erstellen/Aktualisieren Sie die pyproject.toml-Datei im Root Ihres Repositorys.
        # Passen Sie die Werte für Ihre tatsächliche App an.
        echo "Generiere pyproject.toml..."
        cat <<EOF > pyproject.toml
        [project]
        name = "MyPythonApp"
        version = "1.0.0"
        description = "Eine einfache Python-App, gebaut mit BeeWare Briefcase."
        requires-python = ">=3.9"
        # KORREKTUR: Lizenzdefinition nach PEP 621.
        license = { file = "LICENSE" } # Verweist auf die LICENSE-Datei im Root

        [tool.briefcase]
        project_name = "MyPythonApp"
        bundle = "org.example" # Ihre eindeutige Paket-ID (z.B. com.ihrefirma)
        author = "Ihr Name"
        author_email = "ihre.email@example.com"
        url = "https://example.com/mypythonapp"
        requires = [] # Fügen Sie hier Ihre Python-Abhängigkeiten hinzu (z.B. ["kivy", "requests"])

        [tool.briefcase.app.mypythonapp] # Der Name hier muss dem 'project.name' entsprechen (kleingeschrieben und Bindestriche statt Leerzeichen)
        sources = ["."] # sources zeigt auf das Verzeichnis, das das App-Paket enthält (hier: Root)
        # KORREKTUR: main_module ist der NAME DES PAKETS (mypythonapp), nicht der Datei.
        # Briefcase erwartet dann, dass es eine __main__.py im Paket gibt oder eine main.py,
        # die über 'python -m mypythonapp' gestartet werden kann.
        main_module = "mypythonapp" 
        long_description = "Eine ausführlichere Beschreibung Ihrer Anwendung."
        
        [tool.briefcase.app.mypythonapp.android]
        target_device = "generic"
        sdk_version = "34" 
        min_sdk_version = "21"
        build_tools_version = "34.0.0"
        supported_abis = ["arm64-v8a"]
        permissions = []
        EOF

        # --- DEBUGGING-SCHRITTE ---
        echo "--- Dateistruktur nach Vorbereitung ---"
        ls -R
        echo "--- Inhalt von pyproject.toml ---"
        cat pyproject.toml
        echo "-----------------------------------"
        # --- ENDE DEBUGGING-SCHRITTE ---

        echo "Starte den Briefcase-Build für Android..."
        # Briefcase build android wird bei Bedarf automatisch briefcase create und SDK-Installationen verwalten.
        briefcase build android

        # Briefcase platziert die APKs typischerweise in einem Unterordner wie 'android/gradle/MyPythonApp/app/build/outputs/apk/debug/'.
        # Wir suchen die generierte APK-Datei robuster.
        echo "Suche nach der generierten APK-Datei..."
        APK_PATH=$(find android -name "*.apk" -print -quit) # -quit beendet nach dem ersten Fund
        
        if [ -z "$APK_PATH" ]; then
            echo "FEHLER: APK-Datei nicht gefunden. Überprüfen Sie die Briefcase-Ausgabe auf Fehler."
            exit 1
        fi
        echo "APK erfolgreich erstellt unter: $APK_PATH"
        echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV # Setzt die Umgebungsvariable für den Upload

    # 6. Erstelltes APK als Artefakt hochladen
    - name: APK-Artefakt hochladen
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: App-Debug-APK
        path: ${{ env.APK_PATH }} # Verwendet den dynamisch gefundenen Pfad
        retention-days: 7
        
